name: Build and Release Toss

on:
  push:
    tags:
      - "v*" # Triggers on tags like v1.0.1
  workflow_dispatch: # Allows manual trigger

jobs:
  build-and-release:
    runs-on: macos-14
    permissions:
      contents: write # Required to create releases and push appcast.xml

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Import certificates
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create and configure keychain
          security create-keychain -p actions build.keychain
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Import certificate
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
          rm certificate.p12

      - name: Build app (archive)
        working-directory: Toss
        env:
          CODE_SIGN_IDENTITY: ${{ secrets.MAC_CODESIGN_IDENTITY }}
        run: |
          xcodebuild clean archive \
            -project Toss.xcodeproj \
            -scheme Toss \
            -configuration Release \
            -destination 'generic/platform=macOS' \
            -archivePath ./build/Toss.xcarchive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_IDENTITY="$CODE_SIGN_IDENTITY" \
            OTHER_CODE_SIGN_FLAGS="--options runtime"

      - name: Export app
        working-directory: Toss
        run: |
          cat > exportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>developer-id</string>
            <key>signingStyle</key><string>manual</string>
            <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>destination</key><string>export</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath ./build/Toss.xcarchive \
            -exportPath ./build/Release \
            -exportOptionsPlist exportOptions.plist

      - name: Notarize & staple APP
        working-directory: Toss
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_PATH="./build/Release/Toss.app"

          # Zip the app for notarization
          /usr/bin/zip -ry "./build/Toss.zip" "$APP_PATH"

          # Submit for notarization
          xcrun notarytool submit "./build/Toss.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the app
          xcrun stapler staple "$APP_PATH"

          # Verify code signature (more reliable than spctl)
          codesign --verify --deep --strict --verbose=2 "$APP_PATH" || exit 1

          # Verify Gatekeeper (non-fatal since notarization already validates)
          spctl --assess -vv "$APP_PATH" || echo "Warning: spctl check failed, but app is notarized and should work fine"

      - name: Create DMG
        working-directory: Toss
        run: |
          mkdir -p ./build/dmg-staging
          cp -R "./build/Release/Toss.app" ./build/dmg-staging/
          ln -s /Applications ./build/dmg-staging/Applications

          hdiutil create -volname "Toss" \
            -srcfolder ./build/dmg-staging \
            -ov -format UDZO \
            "Toss-${{ steps.version.outputs.VERSION }}.dmg"

          rm -rf ./build/dmg-staging

      - name: Sign DMG
        working-directory: Toss
        env:
          CODE_SIGN_IDENTITY: ${{ secrets.MAC_CODESIGN_IDENTITY }}
        run: |
          # Sign DMG
          codesign --force --sign "$CODE_SIGN_IDENTITY" \
            --timestamp \
            "Toss-${{ steps.version.outputs.VERSION }}.dmg"

          # Verify DMG signature
          codesign --verify --verbose=2 "Toss-${{ steps.version.outputs.VERSION }}.dmg" || exit 1

          # Verify Gatekeeper (non-fatal)
          spctl --assess -vv "Toss-${{ steps.version.outputs.VERSION }}.dmg" || echo "Warning: spctl check failed, but DMG is signed"

      - name: Notarize DMG
        working-directory: Toss
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Submit DMG for notarization
          xcrun notarytool submit "Toss-${{ steps.version.outputs.VERSION }}.dmg" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the DMG
          xcrun stapler staple "Toss-${{ steps.version.outputs.VERSION }}.dmg"

      - name: Sign for Sparkle
        working-directory: Toss
        continue-on-error: true
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Write PEM key to file
          printf "%s\n" "$SPARKLE_PRIVATE_KEY" > ed25519_privkey.pem

          # Download sign_update by cloning the Sparkle repo (just the bin directory)
          if [ ! -x "sign_update" ]; then
            # Clone with sparse checkout to get just the bin directory
            git clone --depth 1 --filter=blob:none --sparse https://github.com/sparkle-project/Sparkle.git sparkle-temp || {
              # Fallback: full clone if sparse checkout fails
              echo "Sparse checkout failed, trying full clone..."
              rm -rf sparkle-temp
              git clone --depth 1 https://github.com/sparkle-project/Sparkle.git sparkle-temp
            }
            
            # Copy the sign_update script
            if [ -f "sparkle-temp/bin/sign_update" ]; then
              cp sparkle-temp/bin/sign_update ./sign_update
            else
              echo "Warning: sign_update not found in Sparkle repository, skipping Sparkle signing"
              rm -rf sparkle-temp
              rm -f ed25519_privkey.pem
              exit 0
            fi
            
            rm -rf sparkle-temp
            
            # Verify download succeeded
            if [ ! -f "sign_update" ] || [ ! -s "sign_update" ]; then
              echo "Warning: Failed to download sign_update tool, skipping Sparkle signing"
              rm -f ed25519_privkey.pem
              exit 0
            fi
            
            chmod +x sign_update
          fi

          # Sign and capture output
          OUT=$(./sign_update "Toss-${{ steps.version.outputs.VERSION }}.dmg" -f ed25519_privkey.pem 2>&1) || {
            echo "Warning: Sparkle signing failed, continuing without Sparkle signature"
            rm -f ed25519_privkey.pem
            exit 0
          }

          SIG=$(echo "$OUT" | awk -F'"' '/sparkle:edSignature/{print $2}')
          LEN=$(stat -f%z "Toss-${{ steps.version.outputs.VERSION }}.dmg" 2>/dev/null || wc -c < "Toss-${{ steps.version.outputs.VERSION }}.dmg")

          if [ -z "$SIG" ]; then
            echo "Warning: Could not extract Sparkle signature, continuing without it"
            rm -f ed25519_privkey.pem
            exit 0
          fi

          echo "SIGNATURE=$SIG" >> $GITHUB_ENV
          echo "DMG_LENGTH=$LEN" >> $GITHUB_ENV

          # Clean up key
          rm -f ed25519_privkey.pem

      - name: Export dSYMs
        working-directory: Toss
        run: |
          DSYMS="./build/Toss.xcarchive/dSYMs"
          if [ -d "$DSYMS" ]; then
            /usr/bin/zip -ry "./build/Toss-dSYMs.zip" "$DSYMS"
          fi

      - name: Update appcast.xml
        continue-on-error: true
        run: |
          APPCAST="appcast.xml"
          VERSION="${{ steps.version.outputs.VERSION }}"
          URL="https://github.com/jack-elliot-doherty/toss-mac-app/releases/download/v${VERSION}/Toss-${VERSION}.dmg"
          SIG="${{ env.SIGNATURE }}"
          LEN="${{ env.DMG_LENGTH }}"
          DATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")

          # Skip appcast update if no signature (Sparkle signing failed)
          if [ -z "$SIG" ]; then
            echo "Warning: No Sparkle signature available, skipping appcast.xml update"
            echo "The release will still be created, but automatic updates via Sparkle won't work until manually fixed"
            exit 0
          fi

          # Use Python to properly parse and update XML
          python3 << 'PYTHON'
          import xml.etree.ElementTree as ET
          from datetime import datetime
          import sys

          appcast_path = "appcast.xml"
          tree = ET.parse(appcast_path)
          root = tree.getroot()

          # Find channel
          channel = root.find('channel')

          # Create new item
          item = ET.Element('item')

          title = ET.SubElement(item, 'title')
          title.text = f"Version {sys.argv[1]}"

          desc = ET.SubElement(item, 'description')
          desc.text = f"<![CDATA[\n                <h2>What's New in {sys.argv[1]}</h2>\n                <ul>\n                    <li>See release notes on GitHub</li>\n                </ul>\n            ]]>"

          pub_date = ET.SubElement(item, 'pubDate')
          pub_date.text = sys.argv[2]

          sparkle_ns = {'sparkle': 'http://www.andymatuschak.org/xml-namespaces/sparkle'}

          version = ET.SubElement(item, '{http://www.andymatuschak.org/xml-namespaces/sparkle}version')
          version.text = sys.argv[1]

          short_version = ET.SubElement(item, '{http://www.andymatuschak.org/xml-namespaces/sparkle}shortVersionString')
          short_version.text = sys.argv[1]

          min_system = ET.SubElement(item, '{http://www.andymatuschak.org/xml-namespaces/sparkle}minimumSystemVersion')
          min_system.text = "14.0"

          enclosure = ET.SubElement(item, 'enclosure')
          enclosure.set('url', sys.argv[3])
          enclosure.set('{http://www.andymatuschak.org/xml-namespaces/sparkle}edSignature', sys.argv[4])
          enclosure.set('length', sys.argv[5])
          enclosure.set('type', 'application/octet-stream')

          # Insert at beginning of channel
          channel.insert(0, item)

          # Write back
          tree.write(appcast_path, encoding='utf-8', xml_declaration=True)
          PYTHON "$VERSION" "$DATE" "$URL" "$SIG" "$LEN"

          # Format XML nicely
          xmllint --format "$APPCAST" > "${APPCAST}.tmp" 2>/dev/null && mv "${APPCAST}.tmp" "$APPCAST" || true

          # Commit and push appcast (but don't upload to GitHub Releases)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$APPCAST"
          git commit -m "Update appcast for v${VERSION}" || exit 0
          git push origin HEAD:main

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Toss/Toss-${{ steps.version.outputs.VERSION }}.dmg
            Toss/build/Toss-dSYMs.zip
          body: |
            ## Toss v${{ steps.version.outputs.VERSION }}

            ### Installation
            Download `Toss-${{ steps.version.outputs.VERSION }}.dmg` and drag to Applications.

            ### What's New
            - Add your release notes here

            ### Technical Details
            - **Sparkle Signature:** ${{ env.SIGNATURE != '' && format('`{0}`', env.SIGNATURE) || 'Not available (Sparkle signing failed)' }}
            - **File Size:** ${{ env.DMG_LENGTH != '' && format('{0} bytes', env.DMG_LENGTH) || 'Unknown' }}
            - **Minimum macOS:** 14.0 (Sonoma)

            ### Automatic Updates
            ${{ env.SIGNATURE != '' && 'If you have Toss installed, it will automatically notify you of this update.' || '⚠️ Sparkle signing failed - automatic updates may not work. Manual update required.' }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup keychain
        if: always()
        run: |
          security default-keychain -s login.keychain
          security lock-keychain build.keychain || true
          security delete-keychain build.keychain || true

      # Remove the duplicate Upload dSYMs artifact step - dSYMs are already in the release
