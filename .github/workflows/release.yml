name: Build and Release Toss

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    build-and-release:
        runs-on: macos-14

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Extract version from tag
              id: version
              run: |
                  if [[ "${{ github.ref }}" == refs/tags/* ]]; then
                    VERSION=${GITHUB_REF#refs/tags/v}
                  else
                    VERSION="dev-$(date +%Y%m%d-%H%M%S)"
                  fi
                  echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
                  echo "Building version: $VERSION"

            - name: Import certificates
              env:
                  CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
                  CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
              run: |
                  # Create and configure keychain
                  security create-keychain -p actions build.keychain
                  security list-keychains -s build.keychain
                  security default-keychain -s build.keychain
                  security unlock-keychain -p actions build.keychain
                  security set-keychain-settings -t 3600 -u build.keychain

                  # Import certificate
                  echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
                  security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
                  security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
                  rm certificate.p12

            - name: Build app (archive)
              working-directory: toss-mac-app/Toss
              env:
                  CODE_SIGN_IDENTITY: ${{ secrets.MAC_CODESIGN_IDENTITY }}
              run: |
                  xcodebuild clean archive \
                    -project Toss.xcodeproj \
                    -scheme Toss \
                    -configuration Release \
                    -destination 'generic/platform=macOS' \
                    -archivePath ./build/Toss.xcarchive \
                    CODE_SIGN_STYLE=Manual \
                    DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
                    CODE_SIGN_IDENTITY="$CODE_SIGN_IDENTITY" \
                    OTHER_CODE_SIGN_FLAGS="--options runtime"

            - name: Export app
              working-directory: toss-mac-app/Toss
              run: |
                  cat > exportOptions.plist << 'EOF'
                  <?xml version="1.0" encoding="UTF-8"?>
                  <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
                  <plist version="1.0">
                  <dict>
                    <key>method</key><string>developer-id</string>
                    <key>signingStyle</key><string>manual</string>
                    <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
                    <key>destination</key><string>export</string>
                  </dict>
                  </plist>
                  EOF

                  xcodebuild -exportArchive \
                    -archivePath ./build/Toss.xcarchive \
                    -exportPath ./build/Release \
                    -exportOptionsPlist exportOptions.plist

            - name: Notarize & staple APP
              working-directory: toss-mac-app/Toss
              env:
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
              run: |
                  APP_PATH="./build/Release/Toss.app"

                  # Zip the app for notarization
                  /usr/bin/zip -ry "./build/Toss.zip" "$APP_PATH"

                  # Submit for notarization
                  xcrun notarytool submit "./build/Toss.zip" \
                    --apple-id "$APPLE_ID" \
                    --password "$APPLE_PASSWORD" \
                    --team-id "$APPLE_TEAM_ID" \
                    --wait

                  # Staple the app
                  xcrun stapler staple "$APP_PATH"

                  # Verify Gatekeeper will accept it
                  spctl --assess -vv "$APP_PATH"

            - name: Create DMG
              working-directory: toss-mac-app/Toss
              run: |
                  mkdir -p ./build/dmg-staging
                  cp -R "./build/Release/Toss.app" ./build/dmg-staging/
                  ln -s /Applications ./build/dmg-staging/Applications

                  hdiutil create -volname "Toss" \
                    -srcfolder ./build/dmg-staging \
                    -ov -format UDZO \
                    "Toss-${{ steps.version.outputs.VERSION }}.dmg"

                  rm -rf ./build/dmg-staging

            - name: Sign DMG
              working-directory: toss-mac-app/Toss
              env:
                  CODE_SIGN_IDENTITY: ${{ secrets.MAC_CODESIGN_IDENTITY }}
              run: |
                  # Sign DMG (no hardened runtime flag for disk images)
                  codesign --force --sign "$CODE_SIGN_IDENTITY" \
                    --timestamp \
                    "Toss-${{ steps.version.outputs.VERSION }}.dmg"

                  # Staple the DMG
                  xcrun stapler staple "Toss-${{ steps.version.outputs.VERSION }}.dmg"

                  # Verify DMG
                  spctl --assess -vv "Toss-${{ steps.version.outputs.VERSION }}.dmg"

            - name: Sign for Sparkle
              working-directory: toss-mac-app/Toss
              env:
                  SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
              run: |
                  # Write PEM key to file
                  printf "%s\n" "$SPARKLE_PRIVATE_KEY" > ed25519_privkey.pem

                  # Download sign_update if not present
                  if [ ! -x "sign_update" ]; then
                    curl -L https://github.com/sparkle-project/Sparkle/releases/latest/download/sign_update -o sign_update
                    chmod +x sign_update
                  fi

                  # Sign and capture output
                  OUT=$(./sign_update "Toss-${{ steps.version.outputs.VERSION }}.dmg" -f ed25519_privkey.pem)
                  SIG=$(echo "$OUT" | awk -F'"' '/sparkle:edSignature/{print $2}')
                  LEN=$(stat -f%z "Toss-${{ steps.version.outputs.VERSION }}.dmg" 2>/dev/null || wc -c < "Toss-${{ steps.version.outputs.VERSION }}.dmg")

                  echo "SIGNATURE=$SIG" >> $GITHUB_ENV
                  echo "DMG_LENGTH=$LEN" >> $GITHUB_ENV

                  # Clean up key
                  rm -f ed25519_privkey.pem

            - name: Export dSYMs
              working-directory: toss-mac-app/Toss
              run: |
                  DSYMS="./build/Toss.xcarchive/dSYMs"
                  if [ -d "$DSYMS" ]; then
                    /usr/bin/zip -ry "./build/Toss-dSYMs.zip" "$DSYMS"
                  fi

            - name: Update appcast.xml
              run: |
                  APPCAST="toss-mac-app/appcast.xml"
                  VERSION="${{ steps.version.outputs.VERSION }}"
                  URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/Toss-${VERSION}.dmg"
                  SIG="${{ env.SIGNATURE }}"
                  LEN="${{ env.DMG_LENGTH }}"
                  DATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")

                  # Create new item entry
                  NEW_ITEM=$(cat << EOF
                  <item>
                      <title>Version ${VERSION}</title>
                      <description><![CDATA[
                          <h2>What's New in ${VERSION}</h2>
                          <ul>
                              <li>See release notes on GitHub</li>
                          </ul>
                      ]]></description>
                      <pubDate>${DATE}</pubDate>
                      <sparkle:version>${VERSION}</sparkle:version>
                      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
                      <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
                      <enclosure 
                          url="${URL}"
                          sparkle:edSignature="${SIG}"
                          length="${LEN}"
                          type="application/octet-stream" />
                  </item>
                  EOF
                  )

                  # Insert new item after <channel> opening tag
                  awk -v new_item="$NEW_ITEM" '
                    /<channel>/ { print; print "        "; print new_item; next }
                    { print }
                  ' "$APPCAST" > "${APPCAST}.tmp"

                  mv "${APPCAST}.tmp" "$APPCAST"

                  # Commit and push appcast
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add "$APPCAST"
                  git commit -m "Update appcast for v${VERSION}"
                  git push origin HEAD:main

            - name: Cleanup keychain
              if: always()
              run: |
                  security default-keychain -s login.keychain
                  security lock-keychain build.keychain || true
                  security delete-keychain build.keychain || true

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      toss-mac-app/Toss/Toss-${{ steps.version.outputs.VERSION }}.dmg
                      toss-mac-app/Toss/build/Toss-dSYMs.zip
                  body: |
                      ## Toss v${{ steps.version.outputs.VERSION }}

                      ### Installation
                      Download `Toss-${{ steps.version.outputs.VERSION }}.dmg` and drag to Applications.

                      ### What's New
                      - Add your release notes here

                      ### Technical Details
                      - **Sparkle Signature:** `${{ env.SIGNATURE }}`
                      - **File Size:** `${{ env.DMG_LENGTH }}` bytes
                      - **Minimum macOS:** 14.0 (Sonoma)

                      ### Automatic Updates
                      If you have Toss installed, it will automatically notify you of this update.
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
